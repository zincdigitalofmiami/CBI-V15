# Vercel Connection Guide

This document describes how the CBI-V15 dashboard connects to Vercel and MotherDuck.

## Project Structure

```
dashboard/
├── .vercel/
│   └── project.json      # Vercel project link config
├── .env.local            # Local environment variables (gitignored)
├── lib/
│   ├── motherduck.ts     # MotherDuck WASM client (for client components)
│   └── md.ts             # Native DuckDB connection (for API routes)
└── next.config.ts        # COOP/COEP headers for WASM support
```

## Vercel Configuration

| Property | Value |
|----------|-------|
| Project Name | `cbi-v15` |
| Project ID | `prj_n0UhCozV2HUrIp2dxKmuUSb0bkAx` |
| Team | `zincdigitalofmiamis-projects` |
| Production URL | https://web-steel-eight-62.vercel.app |

## Environment Variables

### Required for MotherDuck
- `MOTHERDUCK_TOKEN` - Read/write token (REQUIRED)
- `MOTHERDUCK_DB` - Database name (optional, defaults to `cbi_v15`)

### Auto-generated by Vercel
- `VERCEL_OIDC_TOKEN` - OIDC token for Vercel integrations

## Troubleshooting

### Project Not Linked

If you see errors about missing `.vercel/project.json`:

```bash
cd dashboard
vercel link --yes --project cbi-v15
vercel env pull --yes
```

### Missing Environment Variables

Pull latest from Vercel:

```bash
cd dashboard
vercel env pull --yes
```

### MotherDuck Connection Fails

**For API Routes (Native DuckDB):**

1. **Check token is set:**
   ```bash
   # Local
   cat dashboard/.env.local | grep MOTHERDUCK_TOKEN
   
   # Vercel
   vercel env ls
   ```

2. **Verify DuckDB package is installed:**
   ```bash
   cd dashboard
   npm list duckdb
   ```

3. **Test connection:**
   ```bash
   cd dashboard
   npm run dev
   # Visit http://localhost:3000/api/test-wasm
   ```

4. **Common Issues:**
   - `MOTHERDUCK_TOKEN not defined` → Set environment variable
   - `Table does not exist` → Expected for new tables, check schema
   - Connection timeout → Check network/Vercel deployment status

**For Client Components (WASM):**

1. **Check Next.js config has COOP/COEP headers:**
   - Verify `next.config.ts` includes COOP/COEP headers (required for WASM)

2. **Test WASM in browser:**
   - Use only in `'use client'` components
   - Check browser console for WASM errors

3. **Common WASM Issues:**
   - `Worker is not defined` → Don't use WASM in API routes (use native DuckDB instead)
   - Missing COOP/COEP headers → Add to `next.config.ts`
   - Invalid token → Regenerate in MotherDuck dashboard

### Auth0 Issues

The `@auth0/nextjs-auth0@4.x` SDK has a different API than v3. If you see `handleAuth` errors:

- v3 used `handleAuth()` 
- v4 requires different setup with environment variables

### Build Fails

```bash
cd dashboard
npm install
npm run build
```

Check for:
- Missing dependencies
- TypeScript errors
- Import path issues

## Deployment

### Manual Deploy
```bash
cd dashboard
vercel
```

### Production Deploy
```bash
cd dashboard
vercel --prod
```

### GitHub Integration
Push to `main` branch triggers automatic deployment.

## Related Files

- [Terraform IaC](../infrastructure/vercel/README.md)
- [MotherDuck utility](./lib/motherduck.ts)
- [Next.js config](./next.config.ts)
