# CBI-V15 Data Ingestion - GitHub Actions
# Runs scheduled data collection â†’ MotherDuck
# FREE tier: 2,000 minutes/month

name: Data Ingestion

on:
  schedule:
    # Every 6 hours: 6 AM, 12 PM, 6 PM, 12 AM UTC
    - cron: '0 6,12,18,0 * * *'
  workflow_dispatch:  # Manual trigger button

env:
  # Prefer canonical Vercel/MotherDuck integration token if present; fall back to legacy secret name.
  MOTHERDUCK_TOKEN: ${{ secrets.motherduck_storage_MOTHERDUCK_TOKEN || secrets.MOTHERDUCK_STORAGE_MOTHERDUCK_TOKEN || secrets.MOTHERDUCK_TOKEN }}
  MOTHERDUCK_DB: cbi_v15
  DATABENTO_API_KEY: ${{ secrets.DATABENTO_API_KEY }}
  FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
  SCRAPECREATORS_API_KEY: ${{ secrets.SCRAPECREATORS_API_KEY }}
  NOAA_API_TOKEN: ${{ secrets.NOAA_API_TOKEN }}

jobs:
  databento:
    if: ${{ env.MOTHERDUCK_TOKEN != '' && env.DATABENTO_API_KEY != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install duckdb databento pandas requests python-dotenv
      
      - name: Collect Databento futures data
        run: python src/ingestion/databento/collect_daily.py

  fred:
    if: ${{ env.MOTHERDUCK_TOKEN != '' && env.FRED_API_KEY != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install duckdb fredapi pandas requests tenacity python-dotenv pyyaml
      
      - name: Collect FRED FX data
        run: python src/ingestion/fred/collect_fred_fx.py
      
      - name: Collect FRED rates data
        run: python src/ingestion/fred/collect_fred_rates_curve.py
      
      - name: Collect FRED financial conditions
        run: python src/ingestion/fred/collect_fred_financial_conditions.py

  usda:
    if: ${{ env.MOTHERDUCK_TOKEN != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install duckdb pandas requests python-dotenv beautifulsoup4 lxml
      
      - name: Collect USDA Export Sales
        run: python src/ingestion/usda/ingest_export_sales.py
      
      - name: Collect USDA WASDE
        run: python src/ingestion/usda/ingest_wasde.py

  epa:
    if: ${{ env.MOTHERDUCK_TOKEN != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install duckdb pandas requests python-dotenv
      
      - name: Collect EPA RIN prices
        run: python src/ingestion/eia_epa/collect_epa_rin_prices.py

  weather:
    if: ${{ env.MOTHERDUCK_TOKEN != '' && env.NOAA_API_TOKEN != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install duckdb pandas requests python-dotenv
      
      - name: Collect weather data
        run: python src/ingestion/weather/collect_all_weather.py

  scrapecreators:
    if: ${{ env.MOTHERDUCK_TOKEN != '' && env.SCRAPECREATORS_API_KEY != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install duckdb pandas requests python-dotenv

      - name: Collect ScrapeCreators (news + Trump)
        run: python src/ingestion/scrapecreators/collect_all_scrapecreators.py
